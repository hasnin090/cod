import { pgTable, text, serial, integer, boolean, timestamp, jsonb, unique, pgEnum } from "drizzle-orm/pg-core";
import { createInsertSchema } from "drizzle-zod";
import { z } from "zod";

// ?Ò?????è?? ?é?è?à ?ê?Ë???ê?Ï?? ?Ï???Ë?»?ê?Ï?? ?ê?Ï???????Ï?Õ?è?Ï?Ò ?????Ï???Ò?«?»?Ï?à ???è ?Ï???Ò???Ð?è?é
// ?à???Ï?Õ???Ñ: ???Õ?Ò???? ?Ð?ç???ç ?Ï???Ë???ê?Ï?? ?â?à???Ô?? ?ê???â?? ???Ï ???????Î ?Ï???Ô?»?Ï?ê?? ?Ï???Ê?? ?Ð???Ð?Ð ?é?è?ê?» ?Ï???Ò???Õ?è??

// ?é?Ï?Î?à?Ñ ?Ï???Ë?»?ê?Ï?? ?Ï???à?Ò?Ï?Õ?Ñ (?????Ï???Ò?«?»?Ï?à ?Ï???Ð???à?Ô?è ???é???î ???Ï ?Ò?????Î ?Ô?»?ê???Ï?ï)
export const ROLES = {
  ADMIN: 'admin',
  MANAGER: 'manager',
  USER: 'user',
  VIEWER: 'viewer'
} as const;

// ?é?Ï?Î?à?Ñ ?Ï???????Ï?Õ?è?Ï?Ò ?Ï???à?Ò?Ï?Õ?Ñ (?????Ï???Ò?«?»?Ï?à ?Ï???Ð???à?Ô?è ???é???î ???Ï ?Ò?????Î ?Ô?»?ê???Ï?ï)
export const PERMISSIONS = {
  VIEW_DASHBOARD: 'view_dashboard',
  MANAGE_USERS: 'manage_users',
  VIEW_USERS: 'view_users',
  MANAGE_PROJECTS: 'manage_projects',
  VIEW_PROJECTS: 'view_projects',
  MANAGE_PROJECT_TRANSACTIONS: 'manage_project_transactions',
  VIEW_PROJECT_TRANSACTIONS: 'view_project_transactions',
  MANAGE_TRANSACTIONS: 'manage_transactions',
  VIEW_TRANSACTIONS: 'view_transactions',
  MANAGE_DOCUMENTS: 'manage_documents',
  VIEW_DOCUMENTS: 'view_documents',
  VIEW_REPORTS: 'view_reports',
  VIEW_ACTIVITY_LOGS: 'view_activity_logs',
  MANAGE_SETTINGS: 'manage_settings',
  VIEW_INCOME: 'view_income'
} as const;

// Users table - ?????Ò?«?»?à ?Ï???Ð???è?Ñ ?Ï???Õ?Ï???è?Ñ
export const users = pgTable("users", {
  id: serial("id").primaryKey(),
  username: text("username").notNull().unique(),
  password: text("password").notNull(),
  plainPassword: text("plain_password"), // ?â???à?Ñ ?Ï???à???ê?? ?Ï???Ë?????è?Ñ ?????à?»?è???è??
  name: text("name").notNull(),
  email: text("email"), // Haciendo el correo electr??nico opcional (puede ser nulo o vac?Õo)
  role: text("role").notNull().default("user"), // admin, user, manager, viewer
  permissions: jsonb("permissions").default([]).notNull(),
  active: boolean("active").notNull().default(true),
});

// Projects table
export const projects = pgTable("projects", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  description: text("description").notNull(),
  startDate: timestamp("start_date").notNull(),
  budget: integer("budget").default(0), // ?à?è???Ï???è?Ñ ?Ï???à?????ê??
  spent: integer("spent").default(0), // ?Ï???à?Ð???? ?Ï???à???????é
  status: text("status").notNull().default("active"), // active, completed, paused
  progress: integer("progress").notNull().default(0),
  createdBy: integer("created_by").notNull().references(() => users.id),
});

// Transactions table
export const transactions = pgTable("transactions", {
  id: serial("id").primaryKey(),
  date: timestamp("date").notNull(),
  amount: integer("amount").notNull(),
  type: text("type").notNull(), // income, expense
  expenseType: text("expense_type"), // ???ê?? ?Ï???à?????ê??: ???Ï?Ò?Ð?î ?????Ñ?î ?à???Ò???è?Ï?Ò?î ?Ï?Ô?ê?? ?Ò?????è???è?Ñ?î ?à?????ê?? ???Ï?à
  description: text("description").notNull(),
  projectId: integer("project_id").references(() => projects.id),
  createdBy: integer("created_by").notNull().references(() => users.id),
  employeeId: integer("employee_id"), // ?à?????? ?Ï???à?ê???? ???è ?Õ?Ï???Ñ ?à???Ï?à???Ï?Ò ?Ï?????ê?Ï?Ò?Ð
  fileUrl: text("file_url"), // URL ?????à???? ?Ï???à?????é (?Ï?«?Ò?è?Ï???è)
  fileType: text("file_type"), // ???ê?? ?Ï???à???? ?Ï???à?????é (?Ï?«?Ò?è?Ï???è)
  archived: boolean("archived").notNull().default(false), // ?Õ?é?? ?Ï???Ë???????Ñ
});

// UserProjects table - for managing user project assignments
export const userProjects = pgTable("user_projects", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").notNull().references(() => users.id),
  projectId: integer("project_id").notNull().references(() => projects.id),
  assignedAt: timestamp("assigned_at").notNull().defaultNow(),
  assignedBy: integer("assigned_by").notNull().references(() => users.id),
}, (table) => {
  return {
    userProjectUnique: unique().on(table.userId, table.projectId),
  };
});

// Documents table
export const documents = pgTable("documents", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  description: text("description"),
  fileUrl: text("file_url").notNull(),
  fileType: text("file_type").notNull(),
  uploadDate: timestamp("upload_date").notNull(),
  projectId: integer("project_id").references(() => projects.id),
  uploadedBy: integer("uploaded_by").notNull().references(() => users.id),
  isManagerDocument: boolean("is_manager_document").default(false), // ?Í???Ï???Ñ ?Õ?é?? ?????Í???Ï???Ñ ?Í???ë ?Ï???à???Ò???»?Ï?Ò ?Ï???Í?»?Ï???è?Ñ
  category: text("category").default("general"), // ?Ò?????è?? ?Ï???à???Ò???»: receipt, contract, general, etc.
  tags: jsonb("tags").default([]).notNull(), // ?????Ï?à?Ï?Ò ?????Ð?Õ?Ó ?ê?Ï???Ò?????è??
});

// ?Ô?»?ê?? ???Ð?? ?Ï???à???Ò???»?Ï?Ò ?Ð?Ï?????à???è?Ï?Ò ?Ï???à?Ï???è?Ñ
export const documentTransactionLinks = pgTable("document_transaction_links", {
  id: serial("id").primaryKey(),
  documentId: integer("document_id").notNull().references(() => documents.id),
  transactionId: integer("transaction_id").notNull().references(() => transactions.id),
  linkType: text("link_type").notNull().default("receipt"), // receipt, contract, invoice, etc.
  linkedBy: integer("linked_by").notNull().references(() => users.id),
  linkedAt: timestamp("linked_at").notNull().defaultNow(),
  notes: text("notes"), // ?à???Ï?Õ???Ï?Ò ?Í???Ï???è?Ñ ???? ?Ï?????Ð??
}, (table) => {
  return {
    documentTransactionUnique: unique().on(table.documentId, table.transactionId),
  };
});

// Activity Logs table
export const activityLogs = pgTable("activity_logs", {
  id: serial("id").primaryKey(),
  action: text("action").notNull(), // create, update, delete
  entityType: text("entity_type").notNull(), // transaction, project, user, document
  entityId: integer("entity_id").notNull(),
  details: text("details").notNull(),
  timestamp: timestamp("timestamp").notNull().defaultNow(),
  userId: integer("user_id").notNull().references(() => users.id),
});

// Settings table
export const settings = pgTable("settings", {
  id: serial("id").primaryKey(),
  key: text("key").notNull().unique(),
  value: text("value").notNull(),
  description: text("description"),
});

// Transaction Edit Permissions table - ?Í?»?Ï???Ñ ?????Ï?Õ?è?Ï?Ò ?Ò???»?è?? ?Ï???à???Ï?à???Ï?Ò ?Ï???à?Ì?é?Ò?Ñ
export const transactionEditPermissions = pgTable("transaction_edit_permissions", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id), // ?????à???Ò?«?»?à ?Ï???à?Õ?»?»
  projectId: integer("project_id").references(() => projects.id), // ?Ë?ê ?????à?????ê?? ?Ï???à?Õ?»?»
  grantedBy: integer("granted_by").notNull().references(() => users.id), // ?à?? ?à???Õ ?Ï???????Ï?Õ?è?Ñ
  grantedAt: timestamp("granted_at").notNull().defaultNow(), // ?ê?é?Ò ?à???Õ ?Ï???????Ï?Õ?è?Ñ
  expiresAt: timestamp("expires_at").notNull(), // ?Ï???Ò?ç?Ï?É ?Ï???????Ï?Õ?è?Ñ (42 ???Ï???Ñ)
  isActive: boolean("is_active").notNull().default(true), // ?????? ?Ë?à ???Ï
  revokedBy: integer("revoked_by").references(() => users.id), // ?à?? ?Ë?????ë ?Ï???????Ï?Õ?è?Ñ
  revokedAt: timestamp("revoked_at"), // ?ê?é?Ò ?Í?????Ï?É ?Ï???????Ï?Õ?è?Ñ
  reason: text("reason"), // ???Ð?Ð ?à???Õ ?Ï???????Ï?Õ?è?Ñ
  notes: text("notes"), // ?à???Ï?Õ???Ï?Ò ?Í???Ï???è?Ñ
}, (table) => {
  return {
    // ?Ï???Ò?Ë?â?» ?à?? ???»?à ?Ò?â???Ï?? ?Ï???????Ï?Õ?è?Ñ ?????à???Ò?«?»?à ?Ë?ê ?Ï???à?????ê?? ?Ï????????
    userEditPermissionUnique: unique().on(table.userId, table.isActive),
    projectEditPermissionUnique: unique().on(table.projectId, table.isActive),
  };
});

// ?Ô?»?ê?? ?Ë???ê?Ï?? ?Ï???à?????ê???Ï?Ò ???»???Ò?? ?Ï???Ë???Ò?Ï??
export const expenseTypes = pgTable("expense_types", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  description: text("description"),
  projectId: integer("project_id").references(() => projects.id), // ???Ð?? ???ê?? ?Ï???à?????ê?? ?Ð?Ï???à?????ê??
  isActive: boolean("is_active").notNull().default(true),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
}, (table) => {
  return {
    // ?Ï???Ò?Ë?â?» ?à?? ???»?à ?Ò?â???Ï?? ?Ï???à ???ê?? ?Ï???à?????ê?? ???è ?????? ?Ï???à?????ê??
    nameProjectUnique: unique().on(table.name, table.projectId),
  };
});

// ?»???Ò?? ?Ï???Ë???Ò?Ï?? - ?Ï???à?????ê???Ï?Ò ?Ï???à???????Ñ ?Õ???Ð ?Ï?????ê??
export const ledgerEntries = pgTable("ledger_entries", {
  id: serial("id").primaryKey(),
  date: timestamp("date").notNull(),
  transactionId: integer("transaction_id").references(() => transactions.id),
  expenseTypeId: integer("expense_type_id").references(() => expenseTypes.id),
  accountName: text("account_name"), // ?Ï???à ?Ï???Õ???Ï?Ð ???????Ð?? ?à?? ?Ï???à???Ò?Õ?é?Ï?Ò
  amount: integer("amount").notNull(),
  debitAmount: integer("debit_amount").default(0), // ?Ï???à?Ð???? ?Ï???à?»?è??
  creditAmount: integer("credit_amount").default(0), // ?Ï???à?Ð???? ?Ï???»?Ï?Î??
  description: text("description").notNull(),
  projectId: integer("project_id").references(() => projects.id),
  entryType: text("entry_type").notNull(), // "classified" ?Ë?ê "miscellaneous" ?Ë?ê "deferred"
  entryDate: timestamp("entry_date").defaultNow(), // ?Ò?Ï???è?« ?Ï???Í?»?«?Ï??
  createdAt: timestamp("created_at").notNull().defaultNow(),
});

// ???ê?? ?Ï???????»?ê?é: ?????»?ê?é ?Ï???à?»?è?? ?Ë?ê ?????»?ê?é ?à?????ê??
export const fundTypeEnum = pgEnum('fund_type', ['admin', 'project']);

// Funds table - ???Í?»?Ï???Ñ ?Ï???????Ï?»?è?é ?ê?Ï???Ë?????»?Ñ
export const funds = pgTable("funds", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  balance: integer("balance").notNull().default(0),
  type: fundTypeEnum("type").notNull(),
  ownerId: integer("owner_id").references(() => users.id), // ???????»?ê?é ?Ï???à?»?è??
  projectId: integer("project_id").references(() => projects.id), // ???????»?ê?é ?Ï???à?????ê??
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Employees table - ?Ô?»?ê?? ?Ï???à?ê?????è?? ?à???????? ???? ?Ï???à???Ò?«?»?à?è??
export const employees = pgTable("employees", {
  id: serial("id").primaryKey(),
  name: text("name").notNull(),
  salary: integer("salary").notNull().default(0), // ?Ï?????Ï?Ò?Ð ?Ï?????ç???è ?Ï???Ë???Ï???è
  currentBalance: integer("current_balance").notNull().default(0), // ?Ï???????è?» ?Ï???à?Ò?Ð?é?è ?à?? ?Ï?????Ï?Ò?Ð
  totalPaid: integer("total_paid").notNull().default(0), // ?Í?Ô?à?Ï???è ?Ï???à?»???ê?? ?ç???Ï ?Ï?????ç??
  lastSalaryReset: timestamp("last_salary_reset").defaultNow(), // ?Ê?«?? ?Í???Ï?»?Ñ ?Ò???è?è?? ???????Ï?Ò?Ð
  assignedProjectId: integer("assigned_project_id").references(() => projects.id),
  active: boolean("active").notNull().default(true),
  hireDate: timestamp("hire_date").notNull().defaultNow(),
  notes: text("notes"), // ?à???Ï?Õ???Ï?Ò ?Í???Ï???è?Ñ
  createdBy: integer("created_by").notNull().references(() => users.id),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Account Categories table - ?Ò?????è???Ï?Ò ?Ë???ê?Ï?? ?Ï???Õ???Ï?Ð?Ï?Ò ?Ï???à?«?????Ñ
export const accountCategories = pgTable("account_categories", {
  id: serial("id").primaryKey(),
  name: text("name").notNull().unique(),
  description: text("description"),
  active: boolean("active").notNull().default(true),
  createdBy: integer("created_by").notNull().references(() => users.id),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Insertion schemas
export const insertUserSchema = createInsertSchema(users)
  .omit({ id: true })
  .extend({
    password: z.string().min(6, "?â???à?Ñ ?Ï???à???ê?? ?è?Ô?Ð ?Ë?? ?Ò?Õ?Ò?ê?è ?????ë ?Ï???Ë?é?? 6 ?Ë?Õ????"),
    email: z.string().email("?Ï???Ð???è?» ?Ï???Í???â?Ò???ê???è ???è?? ???Ï???Õ").optional().or(z.literal("")),
    projectId: z.number().optional(), // ?Í???Ï???Ñ ?Õ?é?? projectId ?â?«?Ï???è?Ñ ?Í???Ï???è?Ñ ???Ï ?Ò?Ò???Ï?Ð?é ?à?? ?Ï???Ô?»?ê??
    permissions: z.array(z.string()).optional(), // ?????Ï?Õ?è?Ï?Ò ?Ï???à???Ò?«?»?à
  });

export const insertProjectSchema = createInsertSchema(projects)
  .omit({ id: true, progress: true })
  .extend({
    startDate: z.coerce.date(), // ?Ò?Õ?ê?è?? ?Ï???Ò?Ï???è?« ?Ò???é?Ï?Î?è?Ï?ï ?à?? ?Ï???????????Ñ ?Ï???????è?Ñ
    budget: z.number().optional().default(0), // ?à?è???Ï???è?Ñ ?Ï?«?Ò?è?Ï???è?Ñ
    spent: z.number().optional().default(0), // ?Ï???à?Ð???? ?Ï???à???????é ?Ï?«?Ò?è?Ï???è
    createdBy: z.number().optional(), // ???è?Ò?à ?Ò???è?è???ç ???è ?Ï???«?????è?Ñ
  });

export const insertTransactionSchema = createInsertSchema(transactions)
  .omit({ id: true })
  .extend({
    date: z.coerce.date(), // ?Ò?Õ?ê?è?? ?Ï???Ò?Ï???è?« ?Ò???é?Ï?Î?è?Ï?ï ?à?? ?Ï???????????Ñ ?Ï???????è?Ñ
    createdBy: z.number().optional(), // ???è?Ò?à ?Ò???è?è???ç ???è ?Ï???«?????è?Ñ
  });

export const insertDocumentSchema = createInsertSchema(documents).omit({ id: true })
  .extend({
    isManagerDocument: z.boolean().optional().default(false),
  });

export const insertActivityLogSchema = createInsertSchema(activityLogs).omit({ id: true, timestamp: true });

export const insertSettingSchema = createInsertSchema(settings).omit({ id: true });

export const insertUserProjectSchema = createInsertSchema(userProjects).omit({ id: true, assignedAt: true });

export const insertEmployeeSchema = createInsertSchema(employees)
  .omit({ id: true, createdBy: true, createdAt: true, updatedAt: true })
  .extend({
    hireDate: z.coerce.date().optional(),
  });

export type Employee = typeof employees.$inferSelect;
export type InsertEmployee = z.infer<typeof insertEmployeeSchema>;

export const insertFundSchema = createInsertSchema(funds)
  .omit({ id: true, createdAt: true, updatedAt: true })
  .extend({
    type: z.enum(['admin', 'project']),
  });

// Types
export type InsertUser = z.infer<typeof insertUserSchema>;
export type User = typeof users.$inferSelect;

export type InsertProject = z.infer<typeof insertProjectSchema>;
export type Project = typeof projects.$inferSelect;

export type InsertTransaction = z.infer<typeof insertTransactionSchema>;
export type Transaction = typeof transactions.$inferSelect;

export type InsertDocument = z.infer<typeof insertDocumentSchema>;
export type Document = typeof documents.$inferSelect;

export const insertDocumentTransactionLinkSchema = createInsertSchema(documentTransactionLinks)
  .omit({ id: true, linkedAt: true });

export type InsertDocumentTransactionLink = z.infer<typeof insertDocumentTransactionLinkSchema>;
export type DocumentTransactionLink = typeof documentTransactionLinks.$inferSelect;

export type InsertActivityLog = z.infer<typeof insertActivityLogSchema>;
export type ActivityLog = typeof activityLogs.$inferSelect;

export type InsertSetting = z.infer<typeof insertSettingSchema>;
export type Setting = typeof settings.$inferSelect;

// Transaction Edit Permission types
export const insertTransactionEditPermissionSchema = createInsertSchema(transactionEditPermissions).omit({
  id: true,
  grantedAt: true,
});
export type InsertTransactionEditPermission = z.infer<typeof insertTransactionEditPermissionSchema>;
export type TransactionEditPermission = typeof transactionEditPermissions.$inferSelect;

export type InsertUserProject = z.infer<typeof insertUserProjectSchema>;
export type UserProject = typeof userProjects.$inferSelect;

export type InsertFund = z.infer<typeof insertFundSchema>;
export type Fund = typeof funds.$inferSelect;

export const insertExpenseTypeSchema = createInsertSchema(expenseTypes)
  .omit({ id: true, createdAt: true, updatedAt: true })
  .extend({
    projectId: z.number().optional(), // ?à?????? ?Ï???à?????ê?? ?Ï?«?Ò?è?Ï???è
  });

export const insertLedgerEntrySchema = createInsertSchema(ledgerEntries)
  .omit({ id: true, createdAt: true })
  .extend({
    transactionId: z.number().nullable().optional(),
    accountName: z.string().optional(), // ?Ï???à ?Ï???Õ???Ï?Ð ?Ï?«?Ò?è?Ï???è
    debitAmount: z.number().optional().default(0), // ?Ï???à?Ð???? ?Ï???à?»?è??
    creditAmount: z.number().optional().default(0), // ?Ï???à?Ð???? ?Ï???»?Ï?Î??
    entryDate: z.union([z.string(), z.date()]).optional(), // ?Ò?Ï???è?« ?Ï???Í?»?«?Ï??
  });

export const insertAccountCategorySchema = createInsertSchema(accountCategories)
  .omit({ id: true, createdAt: true, updatedAt: true });

export type InsertExpenseType = z.infer<typeof insertExpenseTypeSchema>;
export type ExpenseType = typeof expenseTypes.$inferSelect;

export type InsertLedgerEntry = z.infer<typeof insertLedgerEntrySchema>;
export type LedgerEntry = typeof ledgerEntries.$inferSelect;

export type InsertAccountCategory = z.infer<typeof insertAccountCategorySchema>;
export type AccountCategory = typeof accountCategories.$inferSelect;

// Deferred Payments table - ?Ï???»?????Ï?Ò ?Ï???à?Ì?Ô???Ñ
export const deferredPayments = pgTable("deferred_payments", {
  id: serial("id").primaryKey(),
  beneficiaryName: text("beneficiary_name").notNull(), // ?Ï???à ?Ï???à???Ò???è?»
  totalAmount: integer("total_amount").notNull(), // ?Ï???à?Ð???? ?Ï???Í?Ô?à?Ï???è
  paidAmount: integer("paid_amount").notNull().default(0), // ?Ï???à?Ð???? ?Ï???à?»???ê??
  remainingAmount: integer("remaining_amount").notNull(), // ?Ï???à?Ð???? ?Ï???à?Ò?Ð?é?è
  projectId: integer("project_id").references(() => projects.id),
  userId: integer("user_id").references(() => users.id).notNull(), // ?à?? ?Ë?????Ë ?Ï???»?????Ñ
  status: text("status").notNull().default("pending"), // pending, completed
  description: text("description"), // ?ê???? ?Í???Ï???è
  dueDate: timestamp("due_date"), // ?Ò?Ï???è?« ?Ï???Ï???Ò?Õ?é?Ï?é
  installments: integer("installments").notNull().default(1), // ???»?» ?Ï???Ë?é???Ï??
  paymentFrequency: text("payment_frequency").notNull().default("monthly"), // monthly, quarterly, yearly
  notes: text("notes"), // ?à???Ï?Õ???Ï?Ò ?Í???Ï???è?Ñ
  completedAt: timestamp("completed_at"), // ?Ò?Ï???è?« ?Ï???Í?â?à?Ï??
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

export const insertDeferredPaymentSchema = createInsertSchema(deferredPayments)
  .omit({ id: true, paidAmount: true, status: true, completedAt: true, createdAt: true, updatedAt: true })
  .extend({
    totalAmount: z.number().positive("?Ï???à?Ð???? ?è?Ô?Ð ?Ë?? ?è?â?ê?? ?Ë?â?Ð?? ?à?? ??????"),
    beneficiaryName: z.string().min(1, "?Ï???à ?Ï???à???Ò???è?» ?à?????ê?Ð"),
    remainingAmount: z.number().optional(),
    dueDate: z.union([z.string(), z.date()]).optional().nullable(),
  });

export type InsertDeferredPayment = z.infer<typeof insertDeferredPaymentSchema>;
export type DeferredPayment = typeof deferredPayments.$inferSelect;



// Permission types
export type Permission = keyof typeof PERMISSIONS;
export type Role = keyof typeof ROLES;

// Auth types
export const loginSchema = z.object({
  username: z.string().min(1, "?Ï???à ?Ï???à???Ò?«?»?à ?à?????ê?Ð"),
  password: z.string().min(1, "?â???à?Ñ ?Ï???à???ê?? ?à?????ê?Ð?Ñ"),
});

export type LoginCredentials = z.infer<typeof loginSchema>;

// Completed Works - Independent section for manager-only operations
export const completedWorks = pgTable("completed_works", {
  id: serial("id").primaryKey(),
  title: text("title").notNull(),
  description: text("description"),
  amount: integer("amount"), // Optional amount, doesn't affect system balance
  date: timestamp("date").notNull(),
  category: text("category"), // Optional categorization
  status: text("status").notNull().default("active"), // active, archived
  fileUrl: text("file_url"), // Attached file if any
  fileType: text("file_type"), // File type if any
  createdBy: integer("created_by").notNull().references(() => users.id),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Completed Works Documents - Independent document management
export const completedWorksDocuments = pgTable("completed_works_documents", {
  id: serial("id").primaryKey(),
  title: text("title").notNull(),
  description: text("description"),
  fileUrl: text("file_url").notNull(),
  fileType: text("file_type").notNull(),
  fileSize: integer("file_size"),
  category: text("category"), // Optional categorization
  tags: text("tags"), // Comma-separated tags for organization
  createdBy: integer("created_by").notNull().references(() => users.id),
  createdAt: timestamp("created_at").notNull().defaultNow(),
  updatedAt: timestamp("updated_at").notNull().defaultNow(),
});

// Completed Works schemas
export const insertCompletedWorkSchema = createInsertSchema(completedWorks)
  .omit({ id: true, createdBy: true, createdAt: true, updatedAt: true })
  .extend({
    date: z.union([z.string(), z.date()]),
    amount: z.number().optional().nullable(),
  });

export const insertCompletedWorksDocumentSchema = createInsertSchema(completedWorksDocuments)
  .omit({ id: true, createdBy: true, createdAt: true, updatedAt: true })
  .extend({
    fileSize: z.number().optional().nullable(),
  });

export type InsertCompletedWork = z.infer<typeof insertCompletedWorkSchema>;
export type CompletedWork = typeof completedWorks.$inferSelect;

export type InsertCompletedWorksDocument = z.infer<typeof insertCompletedWorksDocumentSchema>;
export type CompletedWorksDocument = typeof completedWorksDocuments.$inferSelect;
