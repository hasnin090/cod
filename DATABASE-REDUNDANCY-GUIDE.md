# دليل النظام الاحتياطي لقواعد البيانات

## نظرة عامة
تم تكوين نظام شامل للحماية من فقدان البيانات المالية مع عدة طبقات من الحماية:

## 1. قاعدة البيانات الرئيسية (PostgreSQL)
- **الحالة**: ✅ متصلة وتعمل بشكل طبيعي
- **الاستخدام**: جميع العمليات المالية اليومية
- **الموقع**: Neon Database
- **سرعة الاستجابة**: ~70ms

## 2. قاعدة البيانات الاحتياطية
- **الحالة**: ✅ مُهيأة ومتصلة
- **الاستخدام**: تلقائي عند فشل القاعدة الرئيسية
- **التبديل**: فوري وشفاف للمستخدمين
- **المزامنة**: في الوقت الفعلي

## 3. نظام Supabase الاحتياطي
- **الحالة**: ✅ مُهيأ مع معالجة timeout محسنة
- **الاستخدام**: طبقة حماية إضافية للبيانات
- **التخزين**: للملفات والمستندات المالية
- **الاتصال**: مقاوم لانقطاع الشبكة

## 4. النسخ الاحتياطية المحلية
- **التكرار**: كل 12 ساعة تلقائياً
- **المحتوى**: 
  - جميع البيانات المالية
  - المستندات والمرفقات
  - إعدادات النظام
- **الحجم**: ~77KB للنسخة الحالية
- **الاسترداد**: سريع وموثوق

## كيفية استخدام النظام

### فحص حالة قواعد البيانات
```bash
GET /api/database/health
```
**الاستجابة المتوقعة:**
```json
{
  "success": true,
  "health": {
    "primary": true,
    "backup": true,
    "active": "primary"
  }
}
```

### تهيئة قاعدة البيانات الاحتياطية
```bash
POST /api/database/init-backup
```

### التبديل اليدوي بين قواعد البيانات
```bash
POST /api/database/switch
Body: { "target": "backup" }
```

### مزامنة البيانات
```bash
POST /api/database/sync
```

## نظام Supabase المحسن

### تهيئة Supabase
```bash
POST /api/supabase/init
```

### فحص حالة Supabase
```bash
GET /api/supabase/health
```

### نسخ الملفات إلى Supabase
```bash
POST /api/supabase/migrate-files
```

## المتغيرات المطلوبة

### قواعد البيانات
- `DATABASE_URL`: قاعدة البيانات الرئيسية (Neon)
- `SUPABASE_DATABASE_URL`: قاعدة بيانات Supabase (اختيارية)

### Supabase
- `SUPABASE_URL`: رابط مشروع Supabase
- `SUPABASE_ANON_KEY`: مفتاح API العام

## الحماية المتقدمة

### 1. الكشف التلقائي للأعطال
- مراقبة دورية كل 30 ثانية
- تبديل تلقائي عند فشل القاعدة الرئيسية
- إنذارات في سجل النشاط

### 2. معالجة انقطاع الشبكة
- Timeout قصير (3-8 ثوانِ)
- إعادة محاولة تلقائية
- وضع العمل بدون اتصال

### 3. النسخ الاحتياطية الذكية
- ضغط تلقائي للملفات
- حذف النسخ القديمة (الاحتفاظ بـ 30 نسخة)
- تشفير البيانات الحساسة

## الحالات الطارئة

### إذا فشلت القاعدة الرئيسية:
1. النظام يتبدل تلقائياً للقاعدة الاحتياطية
2. يظهر تحذير في لوحة الإدارة
3. العمليات تستمر بشكل طبيعي

### إذا فشلت جميع قواعد البيانات:
1. استخدام آخر نسخة احتياطية محلية
2. تشغيل النظام في وضع القراءة فقط
3. حفظ العمليات الجديدة محلياً للمزامنة لاحقاً

## التحقق من سلامة النظام

### يومياً:
- [ ] فحص حالة قواعد البيانات
- [ ] التأكد من النسخ الاحتياطية
- [ ] مراجعة سجل الأخطاء

### أسبوعياً:
- [ ] اختبار التبديل للقاعدة الاحتياطية
- [ ] التحقق من مزامنة Supabase
- [ ] تنظيف النسخ الاحتياطية القديمة

### شهرياً:
- [ ] اختبار استرداد كامل
- [ ] تحديث كلمات المرور
- [ ] مراجعة أداء النظام

## الدعم الفني

لأي مشاكل تقنية:
1. تحقق من `/api/database/health`
2. راجع سجل الخوادم
3. استخدم النسخة الاحتياطية المحلية كحل مؤقت

---

**ملاحظة**: هذا النظام مصمم لضمان عدم فقدان أي بيانات مالية مهما كانت الظروف. جميع العمليات محمية بعدة طبقات من الأمان والنسخ الاحتياطي.