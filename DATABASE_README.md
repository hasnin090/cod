# دليل قاعدة البيانات - نظام المحاسبة
# Database Setup Guide - Cod Accounting System

## ملفات SQL المتوفرة

### 1. `database-setup.sql` - الإعداد الكامل
- إنشاء جميع الجداول مع القيود والعلاقات
- البيانات الافتراضية (مستخدم المدير، الإعدادات، إلخ)
- الفهارس لتحسين الأداء
- الدوال والـ Triggers
- التعليقات والوثائق

**الاستخدام:**
```bash
psql -U username -d database_name -f database-setup.sql
```

### 2. `database-schema-only.sql` - الجداول فقط
- إنشاء الجداول الأساسية فقط
- بدون بيانات افتراضية
- مناسب للتطوير أو البيئات الاختبارية

**الاستخدام:**
```bash
psql -U username -d database_name -f database-schema-only.sql
```

## هيكل قاعدة البيانات

### الجداول الرئيسية:

#### 1. **users** - المستخدمين
- إدارة المستخدمين والصلاحيات
- أدوار: admin, manager, user, viewer
- نظام الصلاحيات المرن (JSON)

#### 2. **projects** - المشاريع
- معلومات المشاريع والميزانيات
- تتبع التقدم والحالة
- ربط بالمستخدمين المسؤولين

#### 3. **transactions** - المعاملات المالية
- الإيرادات والمصروفات
- ربط بالمشاريع والموظفين
- دعم المرفقات

#### 4. **documents** - المستندات
- إدارة الملفات والمستندات
- ربط بالمشاريع والمعاملات
- تصنيف وعلامات

#### 5. **employees** - الموظفين
- إدارة الرواتب والحسابات
- ربط بالمشاريع
- تتبع المدفوعات

#### 6. **funds** - الصناديق
- صناديق الإدارة والمشاريع
- إدارة الأرصدة
- نوعين: admin, project

#### 7. **expense_types** - أنواع المصروفات
- تصنيف المصروفات
- ربط بمشاريع محددة أو عامة

#### 8. **deferred_payments** - الدفعات المؤجلة
- إدارة الدفعات على أقساط
- تتبع المدفوع والمتبقي

### الجداول المساعدة:

- **user_projects**: ربط المستخدمين بالمشاريع
- **document_transaction_links**: ربط المستندات بالمعاملات
- **activity_logs**: سجل النشاطات
- **settings**: إعدادات النظام
- **transaction_edit_permissions**: صلاحيات التعديل المؤقتة
- **ledger_entries**: دفتر الأستاذ
- **account_categories**: تصنيفات الحسابات
- **completed_works**: الأعمال المنجزة
- **completed_works_documents**: مستندات الأعمال المنجزة

## البيانات الافتراضية

### المستخدم الافتراضي:
- **Username**: admin
- **Password**: admin123
- **Role**: admin
- **Email**: admin@admin.com

### الإعدادات الافتراضية:
- اسم الشركة: شركة تقنية للمقاولات
- العملة: د.ع
- الميزانية الافتراضية: 1,000,000
- حجم الملف الأقصى: 20MB

### أنواع المصروفات الافتراضية:
1. راتب
2. مواد بناء
3. نقل ومواصلات
4. أدوات ومعدات
5. خدمات عامة
6. صيانة

## الفهارس والأداء

الفهارس المنشأة لتحسين الأداء:
- فهارس على المعاملات (المشروع، المنشئ، التاريخ)
- فهارس على المستندات (المشروع)
- فهارس على سجل النشاطات (المستخدم، التاريخ)
- فهارس على الربطات (المستخدم-المشروع)

## الدوال والـ Triggers

### دالة تحديث updated_at:
- تحديث تلقائي لعمود `updated_at` عند التعديل
- مطبقة على: projects, funds, employees, expense_types, إلخ

### دالة التحقق من الأرصدة:
- منع الأرصدة السالبة في الصناديق
- التحقق قبل الإدراج والتحديث

## متطلبات النظام

- **PostgreSQL** 12 أو أحدث
- دعم **JSON/JSONB**
- دعم **ENUM types**
- دعم **Triggers والدوال**

## الاستخدام مع التطبيق

يستخدم التطبيق:
- **Drizzle ORM** للتفاعل مع قاعدة البيانات
- **Neon Database** للإنتاج (اختياري)
- **Environment Variables** للاتصال

### متغيرات البيئة المطلوبة:
```env
DATABASE_URL=postgresql://username:password@localhost:5432/database_name
```

## النسخ الاحتياطية

ينصح بإنشاء نسخ احتياطية دورية:
```bash
pg_dump -U username database_name > backup_$(date +%Y%m%d_%H%M%S).sql
```

## الصيانة

### تنظيف سجل النشاطات:
```sql
DELETE FROM activity_logs WHERE timestamp < NOW() - INTERVAL '6 months';
```

### إعادة فهرسة دورية:
```sql
REINDEX DATABASE database_name;
```

### تحليل الإحصائيات:
```sql
ANALYZE;
```

---

**ملاحظة**: تأكد من وجود صلاحيات كافية لإنشاء الجداول والفهارس والدوال قبل تشغيل السكريبتات.

**الدعم**: للاستفسارات أو المشاكل، راجع documentation أو اتصل بفريق التطوير.
