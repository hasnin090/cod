# دليل إعداد Supabase للنظام المحاسبي

## نظرة عامة

تم تطوير نظام متكامل يدعم ثلاث طبقات لحماية البيانات:
1. **قاعدة البيانات الرئيسية** - PostgreSQL للعمليات اليومية
2. **قاعدة البيانات الاحتياطية** - PostgreSQL ثانية للطوارئ
3. **Supabase** - تخزين سحابي للملفات والنسخ الاحتياطي

## الخطوة 1: إنشاء مشروع Supabase

### إنشاء الحساب والمشروع
1. اذهب إلى [supabase.com](https://supabase.com)
2. قم بإنشاء حساب أو تسجيل الدخول
3. انقر على "New Project"
4. اختر Organization أو أنشئ واحدة جديدة
5. املأ تفاصيل المشروع:
   - **Name**: النظام المحاسبي
   - **Database Password**: كلمة مرور قوية (احفظها جيداً)
   - **Region**: اختر أقرب منطقة جغرافية
6. انقر على "Create new project"

### الحصول على بيانات الاتصال
بعد إنشاء المشروع، ستحتاج إلى:

#### 1. URL والمفاتيح
من صفحة Settings > API:
- `SUPABASE_URL`: مثال `https://abcdefgh.supabase.co`
- `SUPABASE_ANON_KEY`: المفتاح العام للقراءة
- `SUPABASE_SERVICE_ROLE_KEY`: المفتاح السري للإدارة

#### 2. رابط قاعدة البيانات
من صفحة Settings > Database > Connection string:
- اختر "Transaction pooler"
- انسخ الرابط واستبدل `[YOUR-PASSWORD]` بكلمة المرور التي وضعتها

## الخطوة 2: إعداد متغيرات البيئة

أضف المتغيرات التالية إلى ملف `.env`:

```env
# Supabase Configuration
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
SUPABASE_DATABASE_URL=postgresql://postgres:your-password@your-project-id.pooler.supabase.com:5432/postgres
```

## الخطوة 3: إعداد Storage في Supabase

### إنشاء Bucket للملفات
1. اذهب إلى Storage في لوحة تحكم Supabase
2. انقر على "Create bucket"
3. اسم الـ bucket: `files`
4. اجعله Public للوصول المباشر للملفات
5. ضع حدود حجم الملف: 50MB

### إعداد Policies (اختياري)
إذا كنت تريد التحكم في الصلاحيات:
```sql
-- السماح بالقراءة للجميع
CREATE POLICY "Allow public read" ON storage.objects
FOR SELECT USING (bucket_id = 'files');

-- السماح بالكتابة للمستخدمين المصرح لهم
CREATE POLICY "Allow authenticated upload" ON storage.objects
FOR INSERT WITH CHECK (bucket_id = 'files');
```

## الخطوة 4: استخدام النظام

### الوصول إلى إدارة قواعد البيانات
1. سجل دخول كمدير في النظام
2. اذهب إلى قسم "إدارة قواعد البيانات"
3. ستجد ثلاثة أقسام رئيسية:
   - حالة قواعد البيانات المحلية
   - حالة Supabase
   - أدوات الإدارة

### تهيئة Supabase
1. انقر على "تهيئة Supabase" في قسم أدوات إدارة Supabase
2. سيتم فحص الاتصال وإعداد الخدمات
3. تأكد من ظهور علامة خضراء لجميع الخدمات

### نقل الملفات الموجودة
لنقل الملفات المحلية إلى Supabase:

#### الطريقة الأولى: من الواجهة
1. انقر على "نقل الملفات" في قسم أدوات Supabase
2. سيتم رفع جميع الملفات من مجلد `uploads/`
3. ستظهر نتيجة العملية (كم ملف نجح، كم فشل)

#### الطريقة الثانية: تحديث الروابط
بعد نقل الملفات:
1. انقر على "تحديث الروابط"
2. سيتم تحديث جميع روابط الملفات في قاعدة البيانات
3. الملفات ستصبح متاحة من Supabase بدلاً من التخزين المحلي

### مزامنة البيانات
لعمل نسخة احتياطية من البيانات في Supabase:
1. انقر على "مزامنة البيانات" في قسم أدوات Supabase
2. سيتم نسخ جميع الجداول إلى قاعدة بيانات Supabase
3. هذا مفيد للوصول للبيانات من أي مكان

## الخطوة 5: المراقبة والصيانة

### فحص الحالة
- النظام يفحص حالة Supabase تلقائياً كل 30 ثانية
- يمكن تحديث الحالة يدوياً بالنقر على "تحديث حالة Supabase"

### مؤشرات الحالة
- **أخضر**: الخدمة تعمل بشكل طبيعي
- **أحمر**: مشكلة في الاتصال أو الإعداد

### استكشاف الأخطاء
إذا ظهرت مشاكل:

#### مشكلة الاتصال
- تأكد من صحة متغيرات البيئة
- تأكد من أن المشروع في Supabase لا يزال نشطاً
- تحقق من كلمة مرور قاعدة البيانات

#### مشكلة التخزين
- تأكد من إنشاء bucket باسم "files"
- تأكد من أن الـ bucket عام (public)
- تحقق من حدود حجم الملفات

#### مشكلة قاعدة البيانات
- تأكد من صحة رابط قاعدة البيانات
- تحقق من أن Connection pooler مفعل
- تأكد من وجود صلاحيات كافية

## الفوائد من استخدام Supabase

### للملفات
- **أمان أعلى**: حماية مدمجة وشهادات SSL
- **سرعة أكبر**: CDN عالمي لتسريع التحميل
- **مساحة أكبر**: لا حدود على المساحة مقارنة بالخادم المحلي

### للبيانات
- **نسخ احتياطي سحابي**: حماية من فقدان البيانات
- **الوصول من أي مكان**: إمكانية الوصول للبيانات عن بُعد
- **مزامنة تلقائية**: نسخ تلقائي للتحديثات

### للنظام ككل
- **استمرارية العمل**: أربع طبقات حماية للبيانات
- **مرونة أكبر**: خيارات متعددة للتشغيل والاستعادة
- **قابلية التوسع**: جاهز للنمو والتطوير المستقبلي

## ملاحظات مهمة

### التكلفة
- Supabase مجاني حتى حدود معينة
- تحقق من خطط التسعير قبل الاستخدام المكثف

### الأمان
- لا تشارك SERVICE_ROLE_KEY مع أحد
- استخدم HTTPS فقط للاتصالات
- فعّل المصادقة الثنائية على حساب Supabase

### النسخ الاحتياطي
- احتفظ بنسخة محلية من الملفات المهمة
- اعمل نسخ احتياطي دوري من إعدادات Supabase
- اختبر عملية الاستعادة بانتظام

## الدعم الفني

في حالة وجود مشاكل:
1. تحقق من سجل الأنشطة في النظام
2. راجع هذا الدليل مرة أخرى
3. تحقق من documentation الرسمي لـ Supabase
4. تواصل مع الدعم الفني للنظام

---

تم إعداد هذا الدليل لضمان تكامل سلس مع نظام Supabase وتوفير أقصى حماية لبياناتك المحاسبية.